---
import { getCollection, type CollectionEntry } from "astro:content";
import { getPostLink, getLink } from "../../utils/links";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogPost from "../../components/BlogPost.astro";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const uniqueTags = [
    ...new Set(allPosts.map((post) => post.data.tags).flat()),
  ];
  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts
      .filter((post) => post.data.tags.includes(tag))
      .sort((a, b) => a.data.pubDate.getTime() - b.data.pubDate.getTime());
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout pageTitle={tag}>
  <p>找到 <strong>{posts.length}</strong> 篇包含「{tag}」标签的文章</p>
  {
    posts.length > 0 ? (
      <ul>
        {posts.map((post) => (
          <BlogPost url={getPostLink(post.id)} title={post.data.title} />
        ))}
      </ul>
    ) : (
      <p>暂无文章包含此标签。</p>
    )
  }
  <p style="margin-top: 2rem;">
    <a href={getLink('/tags/')}>← 查看所有标签</a>
  </p>
</BaseLayout>
